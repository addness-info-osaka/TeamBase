// ====================================================
// TeamBase ã‚·ãƒ³ãƒ—ãƒ«ãƒˆãƒ©ã‚¤ã‚¢ãƒ«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 
// ====================================================

// è¨­å®šå€¤
const ADMIN_EMAIL = 'info.osaka@addness.co.jp';
const COMPANY_NAME = 'SL.AI Team Base';

// ====================================================
// ãƒ¡ã‚¤ãƒ³é–¢æ•°: æ¯æ—¥ãƒˆãƒ©ã‚¤ã‚¢ãƒ«çŠ¶æ³ã‚’ãƒã‚§ãƒƒã‚¯
// ====================================================
function checkTrialStatus() {
  try {
    Logger.log('=== ãƒˆãƒ©ã‚¤ã‚¢ãƒ«çŠ¶æ³ãƒã‚§ãƒƒã‚¯é–‹å§‹ ===');
    
    const sheet = SpreadsheetApp.getActiveSheet();
    const data = sheet.getDataRange().getValues();
    const today = new Date();
    let processedCount = 0;
    
    // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦2è¡Œç›®ã‹ã‚‰å‡¦ç†
    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      
      // å¿…è¦ãƒ‡ãƒ¼ã‚¿ã®å­˜åœ¨ç¢ºèª
      if (!row[0] || !row[2] || !row[8]) continue; // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã€ãƒ¡ãƒ¼ãƒ«ã€ä¼šç¤¾å
      
      const timestamp = new Date(row[0]); // Aåˆ—: ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
      const email = row[2];               // Cåˆ—: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
      const name = row[1];                // Båˆ—: æ‹…å½“è€…å
      const companyName = row[8];         // Iåˆ—: ä¼šç¤¾å
      const status = row[9] || 'trial';   // Jåˆ—: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
      
      // ãƒˆãƒ©ã‚¤ã‚¢ãƒ«ä¸­ã®ã‚‚ã®ã®ã¿å‡¦ç†
      if (status !== 'trial' && status !== 'pending_approval' && status !== '') {
        continue;
      }
      
      // çµŒéæ—¥æ•°ã‚’è¨ˆç®—
      const diffTime = today - timestamp;
      const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
      
      Logger.log(`è¡Œ${i+1}: ${companyName} - çµŒéæ—¥æ•°: ${diffDays}æ—¥`);
      
      // 12æ—¥ç›®ï¼ˆãƒˆãƒ©ã‚¤ã‚¢ãƒ«çµ‚äº†3æ—¥å‰ï¼‰ã®é€šçŸ¥
      if (diffDays === 12) {
        Logger.log(`12æ—¥ç›®é€šçŸ¥å¯¾è±¡: ${companyName} (${email})`);
        
        const success = sendTrialReminderEmail(email, name, companyName);
        
        if (success) {
          // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
          sheet.getRange(i + 1, 10).setValue('reminder_sent');
          processedCount++;
        }
      }
    }
    
    Logger.log(`=== å‡¦ç†å®Œäº†: ${processedCount}ä»¶ã®é€šçŸ¥ã‚’é€ä¿¡ ===`);
    
  } catch (error) {
    Logger.log('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.toString());
    
    // ç®¡ç†è€…ã«ã‚¨ãƒ©ãƒ¼é€šçŸ¥
    MailApp.sendEmail({
      to: ADMIN_EMAIL,
      subject: 'ã€ERRORã€‘TeamBase ãƒˆãƒ©ã‚¤ã‚¢ãƒ«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  ã‚¨ãƒ©ãƒ¼',
      body: `ãƒˆãƒ©ã‚¤ã‚¢ãƒ«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n\nã‚¨ãƒ©ãƒ¼å†…å®¹:\n${error.toString()}\n\næ™‚åˆ»: ${new Date()}`
    });
  }
}

// ====================================================
// 12æ—¥ç›®ãƒˆãƒ©ã‚¤ã‚¢ãƒ«çµ‚äº†é€šçŸ¥ãƒ¡ãƒ¼ãƒ«é€ä¿¡
// ====================================================
function sendTrialReminderEmail(email, name, companyName) {
  try {
    const subject = 'ã€é‡è¦ã€‘TeamBase ç„¡æ–™ãƒˆãƒ©ã‚¤ã‚¢ãƒ«æœŸé–“çµ‚äº†ã®ãŠçŸ¥ã‚‰ã›';
    
    // è§£ç´„ãƒ•ã‚©ãƒ¼ãƒ URLï¼ˆå®Ÿéš›ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã«å¤‰æ›´ã—ã¦ãã ã•ã„ï¼‰
    const cancelUrl = 'https://your-domain.com/cancel-form.html';
    
    const htmlBody = `
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeamBase - æœ‰æ–™ãƒ—ãƒ©ãƒ³ç§»è¡Œã®ãŠçŸ¥ã‚‰ã›</title>
    <style>
        body {
            font-family: 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', 'Noto Sans JP', sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
        }
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #e74c3c;
            padding-bottom: 20px;
        }
        .logo {
            font-size: 28px;
            font-weight: bold;
            color: #e74c3c;
            margin-bottom: 10px;
        }
        .warning-box {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #f39c12;
        }
        .info-box {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .button {
            display: inline-block;
            background-color: #6c757d;
            color: white;
            padding: 12px 30px;
            text-decoration: none;
            border-radius: 5px;
            font-weight: bold;
            margin: 10px 5px;
            border: none;
            cursor: pointer;
            text-align: center;
        }
        .button:hover {
            background-color: #5a6268;
        }
        .footer {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #dee2e6;
            text-align: center;
            color: #6c757d;
            font-size: 14px;
        }
        .contact-info {
            margin-top: 20px;
            font-size: 14px;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">TeamBase</div>
            <h2>14æ—¥é–“ç„¡æ–™ãƒˆãƒ©ã‚¤ã‚¢ãƒ«æœŸé–“çµ‚äº†ã®ãŠçŸ¥ã‚‰ã›</h2>
        </div>

        <p><strong>${name}</strong> æ§˜</p>
        <p>ã„ã¤ã‚‚TeamBaseã‚’ã”åˆ©ç”¨ã„ãŸã ãã€ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚</p>

        <div class="warning-box">
            <h3>âš ï¸ é‡è¦ãªãŠçŸ¥ã‚‰ã›</h3>
            <p>ãŠå®¢æ§˜ã®TeamBaseç„¡æ–™ãƒˆãƒ©ã‚¤ã‚¢ãƒ«æœŸé–“ãŒé–“ã‚‚ãªãçµ‚äº†ã„ãŸã—ã¾ã™ã€‚</p>
            <p><strong>3æ—¥å¾Œã«è‡ªå‹•çš„ã«æœ‰æ–™ãƒ—ãƒ©ãƒ³ï¼ˆÂ¥10,000/ãƒ¦ãƒ¼ã‚¶ãƒ¼/æœˆï¼‰ã¸ã®ç§»è¡ŒãŒé–‹å§‹ã•ã‚Œã¾ã™ã€‚</strong></p>
        </div>

        <div class="info-box">
            <h3>ğŸ“‹ ä»Šå¾Œã®æµã‚Œ</h3>
            <ul>
                <li><strong>ç¶™ç¶šã‚’ã”å¸Œæœ›ã®å ´åˆï¼š</strong> ç‰¹åˆ¥ãªãŠæ‰‹ç¶šãã¯ä¸è¦ã§ã™ã€‚è‡ªå‹•çš„ã«æœ‰æ–™ãƒ—ãƒ©ãƒ³ã«ç§»è¡Œã•ã‚Œã€è«‹æ±‚ãŒé–‹å§‹ã•ã‚Œã¾ã™ã€‚</li>
                <li><strong>è§£ç´„ã‚’ã”å¸Œæœ›ã®å ´åˆï¼š</strong> ä¸‹è¨˜ã®è§£ç´„ç”³ã—è¾¼ã¿ãƒ•ã‚©ãƒ¼ãƒ ã«ã”å…¥åŠ›ãã ã•ã„ã€‚</li>
            </ul>
        </div>

        <div style="text-align: center; margin: 30px 0;">
            <a href="${cancelUrl}" class="button">è§£ç´„ç”³ã—è¾¼ã¿ãƒ•ã‚©ãƒ¼ãƒ </a>
        </div>

        <div class="info-box">
            <h3>ğŸ’° æœ‰æ–™ãƒ—ãƒ©ãƒ³è©³ç´°</h3>
            <p><strong>æ–™é‡‘ï¼š</strong> Â¥10,000/ãƒ¦ãƒ¼ã‚¶ãƒ¼/æœˆï¼ˆç¨è¾¼ï¼‰</p>
            <p><strong>è«‹æ±‚é–‹å§‹ï¼š</strong> ãƒˆãƒ©ã‚¤ã‚¢ãƒ«æœŸé–“çµ‚äº†ç¿Œæ—¥ã‹ã‚‰</p>
            <p><strong>æ”¯æ‰•ã„æ–¹æ³•ï¼š</strong> ç™»éŒ²æ¸ˆã¿ã®ãŠæ”¯æ‰•ã„æ–¹æ³•ã«ã¦è‡ªå‹•è«‹æ±‚</p>
        </div>

        <div class="contact-info">
            <h3>ãŠå•ã„åˆã‚ã›</h3>
            <p>ã”ä¸æ˜ãªç‚¹ãŒã”ã–ã„ã¾ã—ãŸã‚‰ã€ãŠæ°—è»½ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚</p>
            <p>ğŸ“§ info.osaka@addness.co.jp</p>
            <p>ğŸ“ 06-4400-0754ï¼ˆå¹³æ—¥ 9:00-18:00ï¼‰</p>
        </div>

        <div class="footer">
            <p>ã“ã®ãƒ¡ãƒ¼ãƒ«ã¯è‡ªå‹•é€ä¿¡ã•ã‚Œã¦ã„ã¾ã™ã€‚è¿”ä¿¡ã¯ä¸è¦ã§ã™ã€‚</p>
            <p>Â© 2024 TeamBase. All rights reserved.</p>
        </div>
    </div>
</body>
</html>
`;
    
    MailApp.sendEmail({
      to: email,
      subject: subject,
      htmlBody: htmlBody,
      name: COMPANY_NAME
    });
    
    Logger.log(`12æ—¥ç›®é€šçŸ¥ãƒ¡ãƒ¼ãƒ«é€ä¿¡å®Œäº†: ${email}`);
    
    // ç®¡ç†è€…ã«ã‚‚é€šçŸ¥
    MailApp.sendEmail({
      to: ADMIN_EMAIL,
      subject: 'ã€TeamBaseã€‘12æ—¥ç›®é€šçŸ¥ãƒ¡ãƒ¼ãƒ«é€ä¿¡å®Œäº†',
      body: `ä»¥ä¸‹ã®å¥‘ç´„è€…ã«12æ—¥ç›®é€šçŸ¥ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚\n\nä¼šç¤¾å: ${companyName}\næ‹…å½“è€…: ${name}\nãƒ¡ãƒ¼ãƒ«: ${email}\n\nâ€»è§£ç´„å¸Œæœ›ã®å ´åˆã¯è§£ç´„ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ç”³ã—è¾¼ã¿ãŒå…¥ã‚Šã¾ã™ã€‚`
    });
    
    return true;
    
  } catch (error) {
    Logger.log(`12æ—¥ç›®é€šçŸ¥ãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—: ${error.toString()}`);
    return false;
  }
}

// ====================================================
// è§£ç´„å‡¦ç†æ©Ÿèƒ½
// ====================================================
function processCancellation(email, reason) {
  try {
    const sheet = SpreadsheetApp.getActiveSheet();
    const data = sheet.getDataRange().getValues();
    
    // è©²å½“ã™ã‚‹ç”³ã—è¾¼ã¿ã‚’æ¤œç´¢
    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      
      if (row[2] === email) { // Cåˆ—: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§æ¤œç´¢
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ã€Œè§£ç´„æ¸ˆã¿ã€ã«æ›´æ–°
        sheet.getRange(i + 1, 10).setValue('cancelled');
        sheet.getRange(i + 1, 11).setValue(reason); // Kåˆ—: è§£ç´„ç†ç”±
        sheet.getRange(i + 1, 12).setValue(new Date()); // Låˆ—: è§£ç´„æ—¥æ™‚
        
        // ç®¡ç†è€…ã«è§£ç´„é€šçŸ¥
        MailApp.sendEmail({
          to: ADMIN_EMAIL,
          subject: 'ã€TeamBaseã€‘ãƒˆãƒ©ã‚¤ã‚¢ãƒ«æœŸé–“ä¸­è§£ç´„ç”³ã—è¾¼ã¿',
          body: `ãƒˆãƒ©ã‚¤ã‚¢ãƒ«æœŸé–“ä¸­ã®è§£ç´„ç”³ã—è¾¼ã¿ãŒã‚ã‚Šã¾ã—ãŸã€‚\n\nä¼šç¤¾å: ${row[8]}\næ‹…å½“è€…: ${row[1]}\nãƒ¡ãƒ¼ãƒ«: ${email}\nè§£ç´„ç†ç”±: ${reason}\n\nã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ã€Œcancelledã€ã«æ›´æ–°ã—ã¾ã—ãŸã€‚`
        });
        
        Logger.log(`è§£ç´„å‡¦ç†å®Œäº†: ${email}`);
        return true;
      }
    }
    
    Logger.log(`è©²å½“ã™ã‚‹ç”³ã—è¾¼ã¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${email}`);
    return false;
    
  } catch (error) {
    Logger.log(`è§£ç´„å‡¦ç†ã‚¨ãƒ©ãƒ¼: ${error.toString()}`);
    return false;
  }
}

// ====================================================
// ãƒˆãƒªã‚¬ãƒ¼è¨­å®š
// ====================================================
function setupDailyTrigger() {
  // æ—¢å­˜ãƒˆãƒªã‚¬ãƒ¼ã‚’å‰Šé™¤
  const triggers = ScriptApp.getProjectTriggers();
  triggers.forEach(trigger => {
    if (trigger.getHandlerFunction() === 'checkTrialStatus') {
      ScriptApp.deleteTrigger(trigger);
    }
  });
  
  // æ¯æ—¥åˆå‰9æ™‚ã«å®Ÿè¡Œã™ã‚‹ãƒˆãƒªã‚¬ãƒ¼ã‚’ä½œæˆ
  ScriptApp.newTrigger('checkTrialStatus')
    .timeBased()
    .everyDays(1)
    .atHour(9)
    .create();
    
  Logger.log('æ—¥æ¬¡ãƒˆãƒªã‚¬ãƒ¼ã‚’è¨­å®šã—ã¾ã—ãŸï¼ˆæ¯æ—¥åˆå‰9æ™‚å®Ÿè¡Œï¼‰');
}

// ====================================================
// ãƒ†ã‚¹ãƒˆç”¨é–¢æ•°
// ====================================================
function testTrialReminder() {
  const result = sendTrialReminderEmail('test@example.com', 'ãƒ†ã‚¹ãƒˆ å¤ªéƒ', 'ãƒ†ã‚¹ãƒˆæ ªå¼ä¼šç¤¾');
  Logger.log(`ãƒ†ã‚¹ãƒˆçµæœ: ${result ? 'æˆåŠŸ' : 'å¤±æ•—'}`);
}

// ====================================================
// æ‰‹å‹•å®Ÿè¡Œç”¨
// ====================================================
function manualCheck() {
  Logger.log('=== æ‰‹å‹•å®Ÿè¡Œé–‹å§‹ ===');
  checkTrialStatus();
} 