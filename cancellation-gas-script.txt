// ====================================================
// TeamBase è§£ç´„å‡¦ç†ç”¨GASã‚¹ã‚¯ãƒªãƒ—ãƒˆ
// ====================================================

// è¨­å®šå€¤
const ADMIN_EMAIL = 'info.osaka@addness.co.jp';
const COMPANY_NAME = 'SL.AI Team Base';

// ====================================================
// è§£ç´„ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ã®POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç†
// ====================================================
function doPost(e) {
  try {
    const postData = JSON.parse(e.postData.contents);
    
    // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
    Logger.log("===== è§£ç´„ç”³ã—è¾¼ã¿å—ä¿¡ =====");
    Logger.log(JSON.stringify(postData, null, 2));
    
    if (postData.action === 'cancel') {
      // è§£ç´„å‡¦ç†ã‚’å®Ÿè¡Œ
      const result = processCancellation(
        postData.email,
        postData.company_name,
        postData.name,
        postData.cancel_reason,
        postData.detailed_reason
      );
      
      // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™
      return ContentService.createTextOutput(JSON.stringify({
        result: result ? 'success' : 'error',
        message: result ? 'è§£ç´„ç”³ã—è¾¼ã¿ã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸ' : 'è§£ç´„å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'
      })).setMimeType(ContentService.MimeType.JSON);
    }
    
    return ContentService.createTextOutput(JSON.stringify({
      result: 'error',
      message: 'ä¸æ­£ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ã™'
    })).setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    Logger.log("===== è§£ç´„å‡¦ç†ã‚¨ãƒ©ãƒ¼ =====");
    Logger.log("ã‚¨ãƒ©ãƒ¼: " + error.toString());
    
    return ContentService.createTextOutput(JSON.stringify({
      result: 'error',
      message: 'ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

// ====================================================
// è§£ç´„å‡¦ç†æ©Ÿèƒ½
// ====================================================
function processCancellation(email, companyName, name, cancelReason, detailedReason) {
  try {
    const sheet = SpreadsheetApp.getActiveSheet();
    const data = sheet.getDataRange().getValues();
    
    // è©²å½“ã™ã‚‹ç”³ã—è¾¼ã¿ã‚’æ¤œç´¢
    let found = false;
    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      
      if (row[2] === email) { // Cåˆ—: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§æ¤œç´¢
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ã€Œè§£ç´„æ¸ˆã¿ã€ã«æ›´æ–°
        sheet.getRange(i + 1, 10).setValue('cancelled'); // Jåˆ—: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
        sheet.getRange(i + 1, 11).setValue(cancelReason); // Kåˆ—: è§£ç´„ç†ç”±
        sheet.getRange(i + 1, 12).setValue(detailedReason); // Låˆ—: è©³ç´°ç†ç”±
        sheet.getRange(i + 1, 13).setValue(new Date()); // Måˆ—: è§£ç´„æ—¥æ™‚
        
        found = true;
        break;
      }
    }
    
    if (!found) {
      Logger.log(`è©²å½“ã™ã‚‹ç”³ã—è¾¼ã¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${email}`);
      // è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã§ã‚‚ã€å¿µã®ãŸã‚ç®¡ç†è€…ã«é€šçŸ¥
    }
    
    // ç®¡ç†è€…ã¸ã®è§£ç´„é€šçŸ¥
    sendAdminCancellationNotification(email, companyName, name, cancelReason, detailedReason, found);
    
    // ç”³ã—è¾¼ã¿è€…ã¸ã®è§£ç´„ç¢ºèªãƒ¡ãƒ¼ãƒ«
    sendCancellationConfirmationEmail(email, name, companyName);
    
    Logger.log(`è§£ç´„å‡¦ç†å®Œäº†: ${email}`);
    return true;
    
  } catch (error) {
    Logger.log(`è§£ç´„å‡¦ç†ã‚¨ãƒ©ãƒ¼: ${error.toString()}`);
    return false;
  }
}

// ====================================================
// ç®¡ç†è€…ã¸ã®è§£ç´„é€šçŸ¥ãƒ¡ãƒ¼ãƒ«
// ====================================================
function sendAdminCancellationNotification(email, companyName, name, cancelReason, detailedReason, foundInSheet) {
  const reasonMapping = {
    'cost': 'ã‚³ã‚¹ãƒˆãŒåˆã‚ãªã„',
    'functionality': 'æ©Ÿèƒ½ãŒä¸è¶³ã—ã¦ã„ã‚‹',
    'usability': 'ä½¿ã„ã«ãã„',
    'other_tool': 'ä»–ã®ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã«ãªã£ãŸ',
    'trial_only': 'ãƒˆãƒ©ã‚¤ã‚¢ãƒ«ã®ã¿ã®åˆ©ç”¨äºˆå®šã ã£ãŸ',
    'other': 'ãã®ä»–'
  };
  
  const reasonText = reasonMapping[cancelReason] || cancelReason;
  
  const subject = 'ã€TeamBaseã€‘ãƒˆãƒ©ã‚¤ã‚¢ãƒ«æœŸé–“ä¸­è§£ç´„ç”³ã—è¾¼ã¿';
  const body = `
ãƒˆãƒ©ã‚¤ã‚¢ãƒ«æœŸé–“ä¸­ã®è§£ç´„ç”³ã—è¾¼ã¿ãŒã‚ã‚Šã¾ã—ãŸã€‚

â–  è§£ç´„ç”³ã—è¾¼ã¿æƒ…å ±
ä¼šç¤¾å: ${companyName}
æ‹…å½“è€…å: ${name}
ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹: ${email}
è§£ç´„ç†ç”±: ${reasonText}
è©³ç´°ç†ç”±: ${detailedReason || 'ï¼ˆè¨˜è¼‰ãªã—ï¼‰'}

â–  å‡¦ç†çŠ¶æ³
ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæ›´æ–°: ${foundInSheet ? 'å®Œäº†' : 'è©²å½“ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚‰ãš'}
ç¢ºèªãƒ¡ãƒ¼ãƒ«é€ä¿¡: å®Ÿè¡Œäºˆå®š

â–  å¯¾å¿œäº‹é …
${foundInSheet ? 
  'ãƒ»ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ã€Œcancelledã€ã«æ›´æ–°ã—ã¾ã—ãŸ\nãƒ»è«‹æ±‚å‡¦ç†ã®åœæ­¢ã‚’ã”ç¢ºèªãã ã•ã„' : 
  'ãƒ»ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è©²å½“ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ\nãƒ»æ‰‹å‹•ã§ã®ç¢ºèªã‚’ãŠé¡˜ã„ã—ã¾ã™'
}

ç”³ã—è¾¼ã¿è€…ã«ã¯è§£ç´„ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’è‡ªå‹•é€ä¿¡æ¸ˆã¿ã§ã™ã€‚

è§£ç´„ç”³ã—è¾¼ã¿å—ä»˜æ—¥æ™‚: ${new Date().toLocaleString('ja-JP')}
`;

  try {
    MailApp.sendEmail({
      to: ADMIN_EMAIL,
      subject: subject,
      body: body
    });
    Logger.log('ç®¡ç†è€…ã¸ã®è§£ç´„é€šçŸ¥ãƒ¡ãƒ¼ãƒ«é€ä¿¡å®Œäº†');
  } catch (error) {
    Logger.log('ç®¡ç†è€…ã¸ã®è§£ç´„é€šçŸ¥ãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—: ' + error.toString());
  }
}

// ====================================================
// ç”³ã—è¾¼ã¿è€…ã¸ã®è§£ç´„ç¢ºèªãƒ¡ãƒ¼ãƒ«
// ====================================================
function sendCancellationConfirmationEmail(email, name, companyName) {
  const subject = 'ã€TeamBaseã€‘è§£ç´„ç”³ã—è¾¼ã¿å®Œäº†ã®ãŠçŸ¥ã‚‰ã›';
  
  const htmlBody = `
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TeamBase - è§£ç´„ç”³ã—è¾¼ã¿å®Œäº†</title>
  <style>
    body {
      font-family: 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', 'Noto Sans JP', sans-serif;
      line-height: 1.6;
      color: #333;
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f8f9fa;
    }
    .container {
      background-color: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .header {
      text-align: center;
      margin-bottom: 30px;
      border-bottom: 2px solid #6c757d;
      padding-bottom: 20px;
    }
    .logo {
      font-size: 28px;
      font-weight: bold;
      color: #6c757d;
      margin-bottom: 10px;
    }
    .info-box {
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
    }
    .footer {
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid #dee2e6;
      text-align: center;
      color: #6c757d;
      font-size: 14px;
    }
    .contact-info {
      margin-top: 20px;
      font-size: 14px;
      color: #6c757d;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">TeamBase</div>
      <h2>è§£ç´„ç”³ã—è¾¼ã¿å®Œäº†ã®ãŠçŸ¥ã‚‰ã›</h2>
    </div>

    <p><strong>${name}</strong> æ§˜</p>
    <p>ã“ã®åº¦ã¯ã€TeamBaseã®ç„¡æ–™ãƒˆãƒ©ã‚¤ã‚¢ãƒ«è§£ç´„ç”³ã—è¾¼ã¿ã‚’ã„ãŸã ãã€ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚</p>

    <div class="info-box">
      <h3>âœ… è§£ç´„ç”³ã—è¾¼ã¿å—ä»˜å®Œäº†</h3>
      <p>ä»¥ä¸‹ã®å†…å®¹ã§è§£ç´„ç”³ã—è¾¼ã¿ã‚’å—ã‘ä»˜ã‘ã„ãŸã—ã¾ã—ãŸã€‚</p>
      <ul>
        <li><strong>ä¼šç¤¾åï¼š</strong> ${companyName}</li>
        <li><strong>æ‹…å½“è€…åï¼š</strong> ${name}</li>
        <li><strong>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼š</strong> ${email}</li>
        <li><strong>è§£ç´„ç”³ã—è¾¼ã¿æ—¥æ™‚ï¼š</strong> ${new Date().toLocaleString('ja-JP')}</li>
      </ul>
    </div>

    <div class="info-box">
      <h3>ğŸ“‹ ä»Šå¾Œã®æµã‚Œ</h3>
      <ul>
        <li>è§£ç´„å‡¦ç†ã‚’å®Œäº†ã„ãŸã—ã¾ã™</li>
        <li>ãƒˆãƒ©ã‚¤ã‚¢ãƒ«æœŸé–“çµ‚äº†å¾Œã®è«‹æ±‚ã¯ç™ºç”Ÿã„ãŸã—ã¾ã›ã‚“</li>
        <li>ã‚µãƒ¼ãƒ“ã‚¹ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã¯æ®µéšçš„ã«åˆ¶é™ã•ã‚Œã¾ã™</li>
      </ul>
    </div>

    <p>TeamBaseã‚’ã”åˆ©ç”¨ã„ãŸã ãã€èª ã«ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚<br>
    ä»Šå¾Œã¨ã‚‚ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚</p>

    <div class="contact-info">
      <h3>ãŠå•ã„åˆã‚ã›</h3>
      <p>ã”ä¸æ˜ãªç‚¹ãŒã”ã–ã„ã¾ã—ãŸã‚‰ã€ãŠæ°—è»½ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚</p>
      <p>ğŸ“§ info.osaka@addness.co.jp</p>
      <p>ğŸ“ 06-4400-0754ï¼ˆå¹³æ—¥ 9:00-18:00ï¼‰</p>
    </div>

    <div class="footer">
      <p>ã“ã®ãƒ¡ãƒ¼ãƒ«ã¯è‡ªå‹•é€ä¿¡ã•ã‚Œã¦ã„ã¾ã™ã€‚</p>
      <p>Â© 2024 TeamBase. All rights reserved.</p>
    </div>
  </div>
</body>
</html>
`;

  try {
    MailApp.sendEmail({
      to: email,
      subject: subject,
      htmlBody: htmlBody,
      name: COMPANY_NAME
    });
    Logger.log('è§£ç´„ç¢ºèªãƒ¡ãƒ¼ãƒ«é€ä¿¡å®Œäº†: ' + email);
  } catch (error) {
    Logger.log('è§£ç´„ç¢ºèªãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—: ' + error.toString());
  }
}

// ====================================================
// ãƒ†ã‚¹ãƒˆç”¨é–¢æ•°
// ====================================================
function testCancellation() {
  const result = processCancellation(
    'test@example.com',
    'ãƒ†ã‚¹ãƒˆæ ªå¼ä¼šç¤¾',
    'ãƒ†ã‚¹ãƒˆ å¤ªéƒ',
    'cost',
    'ãƒ†ã‚¹ãƒˆç”¨ã®è§£ç´„ç”³ã—è¾¼ã¿ã§ã™'
  );
  Logger.log(`ãƒ†ã‚¹ãƒˆçµæœ: ${result ? 'æˆåŠŸ' : 'å¤±æ•—'}`);
} 