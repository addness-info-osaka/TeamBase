// ====================================================
// TeamBase è§£ç´„å‡¦ç†ç”¨GASã‚¹ã‚¯ãƒªãƒ—ãƒˆ
// ====================================================

// ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ - è©³ç´°ãªãƒ­ã‚°ã‚’å‡ºåŠ›ã—ã¾ã™
const DEBUG = true;

// è¨­å®šå€¤
const ADMIN_EMAIL = 'info.osaka@addness.co.jp';
const COMPANY_NAME = 'SL.AI Team Base';
const COMPANY_EMAIL = 'noreply@sl-ai.com'; // â† å¿…è¦ã«å¿œã˜ã¦å¤‰æ›´

// ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®åˆ—å®šç¾©
const COLUMNS = {
  TIMESTAMP: 1,        // Aåˆ—: ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
  CONTACT_NAME: 2,     // Båˆ—: æ‹…å½“è€…å  
  EMAIL: 3,            // Cåˆ—: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
  PHONE: 4,            // Dåˆ—: é›»è©±ç•ªå·
  DEPARTMENT: 5,       // Eåˆ—: éƒ¨ç½²å
  EMPLOYEE_COUNT: 6,   // Fåˆ—: å¾“æ¥­å“¡æ•°
  PURPOSE: 7,          // Gåˆ—: å°å…¥ç›®çš„
  EMAIL_STATUS: 8,     // Håˆ—: ãƒ¡ãƒ¼ãƒ«é€ä¿¡çŠ¶æ…‹
  COMPANY_NAME: 9,     // Iåˆ—: ä¼šç¤¾å
  STATUS: 10,          // Jåˆ—: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
  FORM_TYPE: 11,       // Kåˆ—: ãƒ•ã‚©ãƒ¼ãƒ ç¨®åˆ¥
  // è§£ç´„å°‚ç”¨åˆ—
  CANCELLATION_REASON: 12,        // Låˆ—: è§£ç´„ç†ç”±
  CANCELLATION_DETAIL: 13,        // Måˆ—: è§£ç´„è©³ç´°ç†ç”±
  ALLOW_CONTACT: 14,              // Nåˆ—: ä»Šå¾Œã®é€£çµ¡è¨±å¯
  ALLOW_MARKETING: 15,            // Oåˆ—: ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°é€£çµ¡è¨±å¯
  PREFERRED_CONTACT_DATE: 16,     // Påˆ—: å¸Œæœ›é€£çµ¡æ—¥æ™‚
  ADDITIONAL_MESSAGE: 17,         // Qåˆ—: è¿½åŠ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  CANCELLATION_STATUS: 18         // Råˆ—: è§£ç´„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
};

// ====================================================
// GET ãƒªã‚¯ã‚¨ã‚¹ãƒˆå‡¦ç†
// ====================================================
function doGet(e) {
  return ContentService.createTextOutput(JSON.stringify({
    status: 'success',
    message: 'TeamBase çµ±åˆGAS Webã‚¢ãƒ—ãƒªãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™',
    timestamp: new Date().toString(),
    version: '2.0',
    features: ['ç”³ã—è¾¼ã¿å‡¦ç†', 'è§£ç´„å‡¦ç†', 'ãƒ¡ãƒ¼ãƒ«é€šçŸ¥', 'ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆé€£æº']
  })).setMimeType(ContentService.MimeType.JSON);
}

// ====================================================
// è§£ç´„ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ã®POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç†
// ====================================================
function doPost(e) {
  try {
    const postData = JSON.parse(e.postData.contents);
    
    // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
    if (DEBUG) {
      Logger.log("===== å—ä¿¡ãƒ‡ãƒ¼ã‚¿ =====");
      Logger.log(JSON.stringify(postData, null, 2));
    }
    
    if (postData.type === 'cancellation') {
      return handleCancellation(postData);
    } else {
      // æ—¢å­˜ã®ç”³ã—è¾¼ã¿å‡¦ç†
      return handleSignup(postData);
    }
    
  } catch (error) {
    Logger.log("===== ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ =====");
    Logger.log("ã‚¨ãƒ©ãƒ¼: " + error.toString());
    
    return ContentService.createTextOutput(JSON.stringify({
      result: 'error',
      timestamp: new Date().toString(),
      message: 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ',
      error: error.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

// ====================================================
// è§£ç´„å‡¦ç†æ©Ÿèƒ½
// ====================================================
function processCancellation(email, companyName, name, cancelReason, detailedReason) {
  try {
    const sheet = SpreadsheetApp.getActiveSheet();
    const data = sheet.getDataRange().getValues();
    
    // è©²å½“ã™ã‚‹ç”³ã—è¾¼ã¿ã‚’æ¤œç´¢
    let found = false;
    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      
      if (row[2] === email) { // Cåˆ—: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§æ¤œç´¢
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ã€Œè§£ç´„æ¸ˆã¿ã€ã«æ›´æ–°
        sheet.getRange(i + 1, 10).setValue('cancelled'); // Jåˆ—: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
        sheet.getRange(i + 1, 11).setValue(cancelReason); // Kåˆ—: è§£ç´„ç†ç”±
        sheet.getRange(i + 1, 12).setValue(detailedReason); // Låˆ—: è©³ç´°ç†ç”±
        sheet.getRange(i + 1, 13).setValue(new Date()); // Måˆ—: è§£ç´„æ—¥æ™‚
        
        found = true;
        break;
      }
    }
    
    if (!found) {
      Logger.log(`è©²å½“ã™ã‚‹ç”³ã—è¾¼ã¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${email}`);
      // è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã§ã‚‚ã€å¿µã®ãŸã‚ç®¡ç†è€…ã«é€šçŸ¥
    }
    
    // ç®¡ç†è€…ã¸ã®è§£ç´„é€šçŸ¥
    sendAdminCancellationNotification(email, companyName, name, cancelReason, detailedReason, found);
    
    // ç”³ã—è¾¼ã¿è€…ã¸ã®è§£ç´„ç¢ºèªãƒ¡ãƒ¼ãƒ«
    sendCancellationConfirmationEmail(email, name, companyName);
    
    Logger.log(`è§£ç´„å‡¦ç†å®Œäº†: ${email}`);
    return true;
    
  } catch (error) {
    Logger.log(`è§£ç´„å‡¦ç†ã‚¨ãƒ©ãƒ¼: ${error.toString()}`);
    return false;
  }
}

// ====================================================
// ç®¡ç†è€…ã¸ã®è§£ç´„é€šçŸ¥ãƒ¡ãƒ¼ãƒ«
// ====================================================
function sendAdminCancellationNotification(email, companyName, name, cancelReason, detailedReason, foundInSheet) {
  const reasonMapping = {
    'cost': 'ã‚³ã‚¹ãƒˆãŒåˆã‚ãªã„',
    'functionality': 'æ©Ÿèƒ½ãŒä¸è¶³ã—ã¦ã„ã‚‹',
    'usability': 'ä½¿ã„ã«ãã„',
    'other_tool': 'ä»–ã®ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã«ãªã£ãŸ',
    'trial_only': 'ãƒˆãƒ©ã‚¤ã‚¢ãƒ«ã®ã¿ã®åˆ©ç”¨äºˆå®šã ã£ãŸ',
    'other': 'ãã®ä»–'
  };
  
  const reasonText = reasonMapping[cancelReason] || cancelReason;
  
  const subject = 'ã€TeamBaseã€‘ãƒˆãƒ©ã‚¤ã‚¢ãƒ«æœŸé–“ä¸­è§£ç´„ç”³ã—è¾¼ã¿';
  const body = `
ãƒˆãƒ©ã‚¤ã‚¢ãƒ«æœŸé–“ä¸­ã®è§£ç´„ç”³ã—è¾¼ã¿ãŒã‚ã‚Šã¾ã—ãŸã€‚

â–  è§£ç´„ç”³ã—è¾¼ã¿æƒ…å ±
ä¼šç¤¾å: ${companyName}
æ‹…å½“è€…å: ${name}
ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹: ${email}
è§£ç´„ç†ç”±: ${reasonText}
è©³ç´°ç†ç”±: ${detailedReason || 'ï¼ˆè¨˜è¼‰ãªã—ï¼‰'}

â–  å‡¦ç†çŠ¶æ³
ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæ›´æ–°: ${foundInSheet ? 'å®Œäº†' : 'è©²å½“ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚‰ãš'}
ç¢ºèªãƒ¡ãƒ¼ãƒ«é€ä¿¡: å®Ÿè¡Œäºˆå®š

â–  å¯¾å¿œäº‹é …
${foundInSheet ? 
  'ãƒ»ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ã€Œcancelledã€ã«æ›´æ–°ã—ã¾ã—ãŸ\nãƒ»è«‹æ±‚å‡¦ç†ã®åœæ­¢ã‚’ã”ç¢ºèªãã ã•ã„' : 
  'ãƒ»ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è©²å½“ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ\nãƒ»æ‰‹å‹•ã§ã®ç¢ºèªã‚’ãŠé¡˜ã„ã—ã¾ã™'
}

ç”³ã—è¾¼ã¿è€…ã«ã¯è§£ç´„ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’è‡ªå‹•é€ä¿¡æ¸ˆã¿ã§ã™ã€‚

è§£ç´„ç”³ã—è¾¼ã¿å—ä»˜æ—¥æ™‚: ${new Date().toLocaleString('ja-JP')}
`;

  try {
    MailApp.sendEmail({
      to: ADMIN_EMAIL,
      subject: subject,
      body: body
    });
    Logger.log('ç®¡ç†è€…ã¸ã®è§£ç´„é€šçŸ¥ãƒ¡ãƒ¼ãƒ«é€ä¿¡å®Œäº†');
  } catch (error) {
    Logger.log('ç®¡ç†è€…ã¸ã®è§£ç´„é€šçŸ¥ãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—: ' + error.toString());
  }
}

// ====================================================
// ç”³ã—è¾¼ã¿è€…ã¸ã®è§£ç´„ç¢ºèªãƒ¡ãƒ¼ãƒ«
// ====================================================
function sendCancellationConfirmationEmail(email, name, companyName) {
  const subject = 'ã€TeamBaseã€‘è§£ç´„ç”³ã—è¾¼ã¿å®Œäº†ã®ãŠçŸ¥ã‚‰ã›';
  
  const htmlBody = `
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TeamBase - è§£ç´„ç”³ã—è¾¼ã¿å®Œäº†</title>
  <style>
    body {
      font-family: 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', 'Noto Sans JP', sans-serif;
      line-height: 1.6;
      color: #333;
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f8f9fa;
    }
    .container {
      background-color: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .header {
      text-align: center;
      margin-bottom: 30px;
      border-bottom: 2px solid #6c757d;
      padding-bottom: 20px;
    }
    .logo {
      font-size: 28px;
      font-weight: bold;
      color: #6c757d;
      margin-bottom: 10px;
    }
    .info-box {
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
    }
    .footer {
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid #dee2e6;
      text-align: center;
      color: #6c757d;
      font-size: 14px;
    }
    .contact-info {
      margin-top: 20px;
      font-size: 14px;
      color: #6c757d;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">TeamBase</div>
      <h2>è§£ç´„ç”³ã—è¾¼ã¿å®Œäº†ã®ãŠçŸ¥ã‚‰ã›</h2>
    </div>

    <p><strong>${name}</strong> æ§˜</p>
    <p>ã“ã®åº¦ã¯ã€TeamBaseã®ç„¡æ–™ãƒˆãƒ©ã‚¤ã‚¢ãƒ«è§£ç´„ç”³ã—è¾¼ã¿ã‚’ã„ãŸã ãã€ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚</p>

    <div class="info-box">
      <h3>âœ… è§£ç´„ç”³ã—è¾¼ã¿å—ä»˜å®Œäº†</h3>
      <p>ä»¥ä¸‹ã®å†…å®¹ã§è§£ç´„ç”³ã—è¾¼ã¿ã‚’å—ã‘ä»˜ã‘ã„ãŸã—ã¾ã—ãŸã€‚</p>
      <ul>
        <li><strong>ä¼šç¤¾åï¼š</strong> ${companyName}</li>
        <li><strong>æ‹…å½“è€…åï¼š</strong> ${name}</li>
        <li><strong>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼š</strong> ${email}</li>
        <li><strong>è§£ç´„ç”³ã—è¾¼ã¿æ—¥æ™‚ï¼š</strong> ${new Date().toLocaleString('ja-JP')}</li>
      </ul>
    </div>

    <div class="info-box">
      <h3>ğŸ“‹ ä»Šå¾Œã®æµã‚Œ</h3>
      <ul>
        <li>è§£ç´„å‡¦ç†ã‚’å®Œäº†ã„ãŸã—ã¾ã™</li>
        <li>ãƒˆãƒ©ã‚¤ã‚¢ãƒ«æœŸé–“çµ‚äº†å¾Œã®è«‹æ±‚ã¯ç™ºç”Ÿã„ãŸã—ã¾ã›ã‚“</li>
        <li>ã‚µãƒ¼ãƒ“ã‚¹ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã¯æ®µéšçš„ã«åˆ¶é™ã•ã‚Œã¾ã™</li>
      </ul>
    </div>

    <p>TeamBaseã‚’ã”åˆ©ç”¨ã„ãŸã ãã€èª ã«ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚<br>
    ä»Šå¾Œã¨ã‚‚ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚</p>

    <div class="contact-info">
      <h3>ãŠå•ã„åˆã‚ã›</h3>
      <p>ã”ä¸æ˜ãªç‚¹ãŒã”ã–ã„ã¾ã—ãŸã‚‰ã€ãŠæ°—è»½ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚</p>
      <p>ğŸ“§ info.osaka@addness.co.jp</p>
      <p>ğŸ“ 06-4400-0754ï¼ˆå¹³æ—¥ 9:00-18:00ï¼‰</p>
    </div>

    <div class="footer">
      <p>ã“ã®ãƒ¡ãƒ¼ãƒ«ã¯è‡ªå‹•é€ä¿¡ã•ã‚Œã¦ã„ã¾ã™ã€‚</p>
      <p>Â© 2024 TeamBase. All rights reserved.</p>
    </div>
  </div>
</body>
</html>
`;

  try {
    MailApp.sendEmail({
      to: email,
      subject: subject,
      htmlBody: htmlBody,
      name: COMPANY_NAME
    });
    Logger.log('è§£ç´„ç¢ºèªãƒ¡ãƒ¼ãƒ«é€ä¿¡å®Œäº†: ' + email);
  } catch (error) {
    Logger.log('è§£ç´„ç¢ºèªãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—: ' + error.toString());
  }
}

// ====================================================
// ãƒ†ã‚¹ãƒˆç”¨é–¢æ•°
// ====================================================
function testCancellation() {
  const result = processCancellation(
    'test@example.com',
    'ãƒ†ã‚¹ãƒˆæ ªå¼ä¼šç¤¾',
    'ãƒ†ã‚¹ãƒˆ å¤ªéƒ',
    'cost',
    'ãƒ†ã‚¹ãƒˆç”¨ã®è§£ç´„ç”³ã—è¾¼ã¿ã§ã™'
  );
  Logger.log(`ãƒ†ã‚¹ãƒˆçµæœ: ${result ? 'æˆåŠŸ' : 'å¤±æ•—'}`);
}

// è§£ç´„ç”³è«‹ã®å‡¦ç†
function handleCancellation(postData) {
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  var timestamp = new Date();
  
  // æ—¢å­˜ã®ä¼šç¤¾æƒ…å ±ã‚’æ¤œç´¢
  var existingRow = findExistingCompany(sheet, postData.companyData.companyName, postData.companyData.email);
  
  if (existingRow > 0) {
    // æ—¢å­˜é¡§å®¢ã®è§£ç´„å‡¦ç†
    updateExistingCustomerCancellation(sheet, existingRow, postData, timestamp);
  } else {
    // æ–°è¦è¡Œã¨ã—ã¦è§£ç´„ç”³è«‹ã‚’è¨˜éŒ²
    addNewCancellationRow(sheet, postData, timestamp);
  }
  
  // ç®¡ç†è€…ã¸ã®è§£ç´„é€šçŸ¥ãƒ¡ãƒ¼ãƒ«é€ä¿¡
  sendCancellationNotificationToAdmin(postData, existingRow);
  
  // ç”³è«‹è€…ã¸ã®ç¢ºèªãƒ¡ãƒ¼ãƒ«é€ä¿¡
  var emailSent = sendCancellationConfirmationEmail(postData);
  
  // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™
  return ContentService.createTextOutput(JSON.stringify({
    result: 'success',
    timestamp: timestamp.toString(),
    message: 'è§£ç´„ç”³è«‹ã‚’æ­£å¸¸ã«å—ä¿¡ã—ã€ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸ',
    isExistingCustomer: existingRow > 0,
    emailSent: emailSent
  })).setMimeType(ContentService.MimeType.JSON);
}

// æ—¢å­˜é¡§å®¢ã®æ¤œç´¢
function findExistingCompany(sheet, companyName, email) {
  var lastRow = sheet.getLastRow();
  
  if (lastRow < 2) return 0; // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã®ã¿ã®å ´åˆ
  
  // ä¼šç¤¾åã¨ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§æ¤œç´¢
  for (var i = 2; i <= lastRow; i++) {
    var sheetCompanyName = sheet.getRange(i, COLUMNS.COMPANY_NAME).getValue();
    var sheetEmail = sheet.getRange(i, COLUMNS.EMAIL).getValue();
    
    if (sheetCompanyName === companyName && sheetEmail === email) {
      return i;
    }
  }
  
  return 0; // è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆ
}

// æ—¢å­˜é¡§å®¢ã®è§£ç´„æƒ…å ±æ›´æ–°
function updateExistingCustomerCancellation(sheet, row, postData, timestamp) {
  // è§£ç´„æƒ…å ±ã‚’è¿½åŠ 
  sheet.getRange(row, COLUMNS.CANCELLATION_REASON).setValue(postData.cancellationData.reason);
  sheet.getRange(row, COLUMNS.CANCELLATION_DETAIL).setValue(postData.cancellationData.detailReason);
  sheet.getRange(row, COLUMNS.ALLOW_CONTACT).setValue(postData.cancellationData.allowContact ? 'ã¯ã„' : 'ã„ã„ãˆ');
  sheet.getRange(row, COLUMNS.ALLOW_MARKETING).setValue(postData.cancellationData.allowMarketing ? 'ã¯ã„' : 'ã„ã„ãˆ');
  sheet.getRange(row, COLUMNS.PREFERRED_CONTACT_DATE).setValue(postData.cancellationData.preferredContactDate);
  sheet.getRange(row, COLUMNS.ADDITIONAL_MESSAGE).setValue(postData.cancellationData.additionalMessage);
  sheet.getRange(row, COLUMNS.CANCELLATION_STATUS).setValue('è§£ç´„ç”³è«‹å—ä»˜');
  
  // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
  sheet.getRange(row, COLUMNS.STATUS).setValue('è§£ç´„ç”³è«‹ä¸­');
  
  Logger.log(`æ—¢å­˜é¡§å®¢ã®è§£ç´„ç”³è«‹ã‚’æ›´æ–°ã—ã¾ã—ãŸ - è¡Œ: ${row}`);
}

// æ–°è¦è§£ç´„ç”³è«‹è¡Œã®è¿½åŠ 
function addNewCancellationRow(sheet, postData, timestamp) {
  var lastRow = sheet.getLastRow() + 1;
  
  // åŸºæœ¬æƒ…å ±ã‚’è¨˜éŒ²
  sheet.getRange(lastRow, COLUMNS.TIMESTAMP).setValue(timestamp);
  sheet.getRange(lastRow, COLUMNS.CONTACT_NAME).setValue(postData.companyData.contactName);
  sheet.getRange(lastRow, COLUMNS.EMAIL).setValue(postData.companyData.email);
  sheet.getRange(lastRow, COLUMNS.PHONE).setValue(postData.companyData.phoneNumber);
  sheet.getRange(lastRow, COLUMNS.EMAIL_STATUS).setValue('æœªé€ä¿¡');
  sheet.getRange(lastRow, COLUMNS.COMPANY_NAME).setValue(postData.companyData.companyName || '');
  sheet.getRange(lastRow, COLUMNS.STATUS).setValue('è§£ç´„ç”³è«‹ä¸­');
  sheet.getRange(lastRow, COLUMNS.FORM_TYPE).setValue('è§£ç´„ç”³è«‹');
  
  // è§£ç´„æƒ…å ±ã‚’è¨˜éŒ²
  sheet.getRange(lastRow, COLUMNS.CANCELLATION_REASON).setValue(postData.cancellationData.reason);
  sheet.getRange(lastRow, COLUMNS.CANCELLATION_DETAIL).setValue(postData.cancellationData.detailReason);
  sheet.getRange(lastRow, COLUMNS.ALLOW_CONTACT).setValue(postData.cancellationData.allowContact ? 'ã¯ã„' : 'ã„ã„ãˆ');
  sheet.getRange(lastRow, COLUMNS.ALLOW_MARKETING).setValue(postData.cancellationData.allowMarketing ? 'ã¯ã„' : 'ã„ã„ãˆ');
  sheet.getRange(lastRow, COLUMNS.PREFERRED_CONTACT_DATE).setValue(postData.cancellationData.preferredContactDate);
  sheet.getRange(lastRow, COLUMNS.ADDITIONAL_MESSAGE).setValue(postData.cancellationData.additionalMessage);
  sheet.getRange(lastRow, COLUMNS.CANCELLATION_STATUS).setValue('è§£ç´„ç”³è«‹å—ä»˜');
  
  Logger.log(`æ–°è¦è§£ç´„ç”³è«‹ã‚’è¨˜éŒ²ã—ã¾ã—ãŸ - è¡Œ: ${lastRow}`);
}

// ç®¡ç†è€…ã¸ã®è§£ç´„é€šçŸ¥ãƒ¡ãƒ¼ãƒ«
function sendCancellationNotificationToAdmin(postData, existingRow) {
  var subject = 'ã€TeamBaseã€‘è§£ç´„ç”³è«‹ãŒã‚ã‚Šã¾ã—ãŸ';
  
  // è§£ç´„ç†ç”±ã®ãƒ†ã‚­ã‚¹ãƒˆå¤‰æ›
  var reasonText = getCancellationReasonText(postData.cancellationData.reason);
  
  var body = `
TeamBaseã®è§£ç´„ç”³è«‹ãŒã‚ã‚Šã¾ã—ãŸã€‚

ç”³è«‹è€…æƒ…å ±ï¼š
ä¼šç¤¾å: ${postData.companyData.companyName}
æ‹…å½“è€…å: ${postData.companyData.contactName}
ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹: ${postData.companyData.email}
é›»è©±ç•ªå·: ${postData.companyData.phoneNumber || 'æœªå…¥åŠ›'}

è§£ç´„æƒ…å ±ï¼š
è§£ç´„ç†ç”±: ${reasonText}
è©³ç´°ç†ç”±: ${postData.cancellationData.detailReason || 'æœªå…¥åŠ›'}
ä»Šå¾Œã®é€£çµ¡è¨±å¯: ${postData.cancellationData.allowContact ? 'ã¯ã„' : 'ã„ã„ãˆ'}
ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°é€£çµ¡è¨±å¯: ${postData.cancellationData.allowMarketing ? 'ã¯ã„' : 'ã„ã„ãˆ'}
å¸Œæœ›é€£çµ¡æ—¥æ™‚: ${postData.cancellationData.preferredContactDate || 'æŒ‡å®šãªã—'}
è¿½åŠ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ${postData.cancellationData.additionalMessage || 'ãªã—'}

${existingRow > 0 ? `æ—¢å­˜é¡§å®¢ï¼ˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ${existingRow}è¡Œç›®ï¼‰ã®è§£ç´„ç”³è«‹ã§ã™ã€‚` : 'æ–°è¦è§£ç´„ç”³è«‹ã¨ã—ã¦ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è¨˜éŒ²ã•ã‚Œã¾ã—ãŸã€‚'}

ç”³è«‹è€…ã«ã¯è‡ªå‹•ã§ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡æ¸ˆã¿ã§ã™ã€‚
ç¿Œå–¶æ¥­æ—¥ä»¥å†…ã«æ‹…å½“è€…ã‹ã‚‰ã”é€£çµ¡ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚

ã€é‡è¦ã€‘è§£ç´„å‡¦ç†å®Ÿè¡Œæ™‚ã¯ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š
1. ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ç„¡åŠ¹åŒ–
2. è«‹æ±‚å‡¦ç†ã®åœæ­¢
3. ãƒ‡ãƒ¼ã‚¿ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
4. ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤
`;

  try {
    MailApp.sendEmail({
      to: ADMIN_EMAIL,
      subject: subject,
      body: body
    });
    Logger.log('ç®¡ç†è€…ã¸ã®è§£ç´„é€šçŸ¥ãƒ¡ãƒ¼ãƒ«é€ä¿¡å®Œäº†');
  } catch (error) {
    Logger.log('ç®¡ç†è€…ã¸ã®è§£ç´„é€šçŸ¥ãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—: ' + error.toString());
  }
}

// è§£ç´„ç†ç”±ã‚³ãƒ¼ãƒ‰ã‚’æ—¥æœ¬èªãƒ†ã‚­ã‚¹ãƒˆã«å¤‰æ›
function getCancellationReasonText(reasonCode) {
  const reasonMap = {
    'cost': 'ğŸ’° ã‚³ã‚¹ãƒˆãŒåˆã‚ãªã„',
    'functionality': 'âš™ï¸ æ©Ÿèƒ½ãŒè¦ä»¶ã«åˆã‚ãªã„', 
    'usage': 'ğŸ‘¥ ãƒãƒ¼ãƒ ã§ã®åˆ©ç”¨ãŒé€²ã¾ãªã„',
    'alternative': 'ğŸ”„ ä»–ã®ãƒ„ãƒ¼ãƒ«ã«ç§»è¡Œ',
    'temporary': 'â¸ï¸ ä¸€æ™‚çš„ãªåˆ©ç”¨åœæ­¢',
    'other': 'ğŸ“ ãã®ä»–'
  };
  
  return reasonMap[reasonCode] || reasonCode;
}

// æ—¢å­˜ã®ç”³ã—è¾¼ã¿å‡¦ç†ï¼ˆå¾“æ¥ã®æ©Ÿèƒ½ã‚’ç¶­æŒï¼‰
function handleSignup(postData) {
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  var lastRow = sheet.getLastRow() + 1;
  var timestamp = new Date();
  
  // ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ãƒ•ã‚©ãƒ¼ãƒ ç”¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«æ›¸ãè¾¼ã‚€
  sheet.getRange(lastRow, COLUMNS.TIMESTAMP).setValue(timestamp);
  sheet.getRange(lastRow, COLUMNS.CONTACT_NAME).setValue(postData.columnB || '');
  sheet.getRange(lastRow, COLUMNS.EMAIL).setValue(postData.columnC || '');
  sheet.getRange(lastRow, COLUMNS.PHONE).setValue(postData.columnD || '');
  sheet.getRange(lastRow, COLUMNS.DEPARTMENT).setValue(postData.columnE || '');
  sheet.getRange(lastRow, COLUMNS.EMPLOYEE_COUNT).setValue(postData.columnF || '');
  sheet.getRange(lastRow, COLUMNS.PURPOSE).setValue(postData.columnG || '');
  sheet.getRange(lastRow, COLUMNS.EMAIL_STATUS).setValue('æœªé€ä¿¡');
  
  // ä¼šç¤¾æƒ…å ±ã‚’è¿½åŠ åˆ—ã«ä¿å­˜
  if (postData.companyData) {
    sheet.getRange(lastRow, COLUMNS.COMPANY_NAME).setValue(postData.companyData.companyName || '');
    sheet.getRange(lastRow, COLUMNS.STATUS).setValue(postData.companyData.status || '');
    sheet.getRange(lastRow, COLUMNS.FORM_TYPE).setValue(postData.companyData.formType || 'ç”³ã—è¾¼ã¿');
  }
  
  // ç®¡ç†è€…ã¸ã®é€šçŸ¥ãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼ˆæ—¢å­˜æ©Ÿèƒ½ï¼‰
  sendAdminNotification(postData, lastRow);
  
  // ç”³ã—è¾¼ã¿è€…æœ¬äººã¸ã®ç¢ºèªãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼ˆæ—¢å­˜æ©Ÿèƒ½ï¼‰
  var emailSent = sendConfirmationEmail(postData);
  
  // ãƒ¡ãƒ¼ãƒ«é€ä¿¡çŠ¶æ…‹ã‚’æ›´æ–°
  if (emailSent) {
    sheet.getRange(lastRow, COLUMNS.EMAIL_STATUS).setValue('é€ä¿¡å®Œäº†');
  } else {
    sheet.getRange(lastRow, COLUMNS.EMAIL_STATUS).setValue('é€ä¿¡å¤±æ•—');
  }
  
  return ContentService.createTextOutput(JSON.stringify({
    result: 'success',
    timestamp: timestamp.toString(),
    message: 'ãŠç”³ã—è¾¼ã¿ãƒ‡ãƒ¼ã‚¿ã‚’æ­£å¸¸ã«å—ä¿¡ã—ã€ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸ',
    rowNumber: lastRow,
    emailSent: emailSent
  })).setMimeType(ContentService.MimeType.JSON);
}

// ç®¡ç†è€…ã¸ã®é€šçŸ¥ãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼ˆæ—¢å­˜æ©Ÿèƒ½ï¼‰
function sendAdminNotification(postData, rowNumber) {
  var subject = 'ã€TeamBaseã€‘æ–°ã—ã„ç„¡æ–™ãƒˆãƒ©ã‚¤ã‚¢ãƒ«ç”³ã—è¾¼ã¿ãŒã‚ã‚Šã¾ã—ãŸ';
  var body = `
æ–°ã—ã„TeamBaseã®ç„¡æ–™ãƒˆãƒ©ã‚¤ã‚¢ãƒ«ç”³ã—è¾¼ã¿ãŒã‚ã‚Šã¾ã—ãŸã€‚

ç”³ã—è¾¼ã¿è€…æƒ…å ±ï¼š
ä¼šç¤¾å: ${postData.companyData?.companyName || 'æœªå…¥åŠ›'}
æ‹…å½“è€…å: ${postData.columnB || 'æœªå…¥åŠ›'}
ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹: ${postData.columnC || 'æœªå…¥åŠ›'}
é›»è©±ç•ªå·: ${postData.columnD || 'æœªå…¥åŠ›'}
éƒ¨ç½²å: ${postData.columnE || 'æœªå…¥åŠ›'}
å¾“æ¥­å“¡æ•°: ${postData.columnF || 'æœªå…¥åŠ›'}
å°å…¥ç›®çš„: ${postData.columnG || 'æœªå…¥åŠ›'}

ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®${rowNumber}è¡Œç›®ã«è©³ç´°ã‚’è¨˜éŒ²ã—ã¾ã—ãŸã€‚

ç”³ã—è¾¼ã¿è€…ã«ã¯è‡ªå‹•ã§ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡æ¸ˆã¿ã§ã™ã€‚
ç¶šã‘ã¦ã‚ªãƒ³ãƒœãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚µãƒãƒ¼ãƒˆã®æº–å‚™ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚
`;

  try {
    MailApp.sendEmail({
      to: ADMIN_EMAIL,
      subject: subject,
      body: body
    });
    Logger.log('ç®¡ç†è€…ã¸ã®é€šçŸ¥ãƒ¡ãƒ¼ãƒ«é€ä¿¡å®Œäº†');
  } catch (error) {
    Logger.log('ç®¡ç†è€…ã¸ã®é€šçŸ¥ãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—: ' + error.toString());
  }
}

// ç”³ã—è¾¼ã¿è€…æœ¬äººã¸ã®ç¢ºèªãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼ˆæ—¢å­˜æ©Ÿèƒ½ï¼‰
function sendConfirmationEmail(postData) {
  var email = postData.columnC;
  var name = postData.columnB;
  var companyName = postData.companyData?.companyName || '';
  
  if (!email) {
    Logger.log('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
    return false;
  }
  
  var subject = 'ã€TeamBaseã€‘ç„¡æ–™ãƒˆãƒ©ã‚¤ã‚¢ãƒ«ç”³ã—è¾¼ã¿æ‰¿èªãƒªãƒ³ã‚¯ã‚’ãŠé€ã‚Šã—ã¾ã™';
  
  // ã‚ªãƒ³ãƒœãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒšãƒ¼ã‚¸ã®ãƒªãƒ³ã‚¯ï¼ˆGitHub Pagesï¼‰
  var onboardingLink = 'https://addness-info-osaka.github.io/TeamBase/step1-todo.html';
  
  var htmlBody = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <style>
    body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
    .container { max-width: 600px; margin: 0 auto; padding: 20px; }
    .header { background: linear-gradient(135deg, #4A6FFF 0%, #6B8AFF 100%); color: white; padding: 20px; text-align: center; border-radius: 8px 8px 0 0; }
    .content { background: #f8f9fa; padding: 30px; border-radius: 0 0 8px 8px; }
    .button { display: inline-block; background: linear-gradient(135deg, #4A6FFF 0%, #6B8AFF 100%); color: white; padding: 15px 30px; text-decoration: none; border-radius: 8px; margin: 20px 0; font-weight: bold; }
    .footer { text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; color: #666; font-size: 14px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>TeamBase ç„¡æ–™ãƒˆãƒ©ã‚¤ã‚¢ãƒ«ç”³ã—è¾¼ã¿ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™</h1>
    </div>
    <div class="content">
      <p>${name} æ§˜</p>
      
      <p>ã“ã®åº¦ã¯ã€TeamBaseã®ç„¡æ–™ãƒˆãƒ©ã‚¤ã‚¢ãƒ«ã«ãŠç”³ã—è¾¼ã¿ã„ãŸã ãã€èª ã«ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚</p>
      
      <p><strong>ç”³ã—è¾¼ã¿å†…å®¹ç¢ºèªï¼š</strong></p>
      <ul>
        <li>ä¼šç¤¾å: ${companyName}</li>
        <li>æ‹…å½“è€…å: ${name}</li>
        <li>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹: ${email}</li>
      </ul>
      
      <p>ç”³ã—è¾¼ã¿ã‚’æ‰¿èªã™ã‚‹ãŸã‚ã€ä¸‹è¨˜ã®ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚ªãƒ³ãƒœãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ï¼š</p>
      
      <p style="text-align: center;">
        <a href="${onboardingLink}" class="button">ã‚ªãƒ³ãƒœãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’é–‹å§‹ã™ã‚‹</a>
      </p>
      
      <p><strong>æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼š</strong></p>
      <ol>
        <li><strong>Step 1:</strong> ä¸Šè¨˜ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦Todo Appã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ</li>
        <li><strong>Step 2:</strong> TeamBaseã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆã¨çµ„ç¹”æƒ…å ±è¨­å®š</li>
        <li><strong>Step 3:</strong> Academyå‹•ç”»ã§TeamBaseã®ä½¿ã„æ–¹ã‚’å®Œå…¨ãƒã‚¹ã‚¿ãƒ¼</li>
      </ol>
      
      <p><strong>ğŸ”– ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯æ¨å¥¨:</strong> ã‚ªãƒ³ãƒœãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒšãƒ¼ã‚¸ã¯ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã—ã¦ãŠãã¨ä¾¿åˆ©ã§ã™ï¼</p>
      
      <p>ã”ä¸æ˜ãªç‚¹ãŒã”ã–ã„ã¾ã—ãŸã‚‰ã€ãŠæ°—è»½ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚</p>
      
      <p>ä»Šå¾Œã¨ã‚‚ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚</p>
    </div>
    <div class="footer">
      <p><strong>ã‚¢ãƒ‰ãƒã‚¹æ ªå¼ä¼šç¤¾ SL.AI Team Base</strong><br>
      ã€’540-0021 å¤§é˜ªåºœå¤§é˜ªå¸‚ä¸­å¤®åŒºå¤§æ‰‹é€šï¼’ä¸ç›®ï¼”âˆ’ï¼˜ assesså¤§æ‰‹é€šãƒ“ãƒ«ï¼”F<br>
      TEL: 06-4400-0754 | Email: info.osaka@addness.co.jp</p>
    </div>
  </div>
</body>
</html>
`;

  try {
    MailApp.sendEmail({
      to: email,
      subject: subject,
      htmlBody: htmlBody,
      name: COMPANY_NAME
    });
    Logger.log('ç”³ã—è¾¼ã¿è€…ã¸ã®ç¢ºèªãƒ¡ãƒ¼ãƒ«é€ä¿¡å®Œäº†: ' + email);
    return true;
  } catch (error) {
    Logger.log('ç”³ã—è¾¼ã¿è€…ã¸ã®ç¢ºèªãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—: ' + error.toString());
    return false;
  }
}

// ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’è‡ªå‹•è¨­å®šã™ã‚‹é–¢æ•°ï¼ˆåˆå›è¨­å®šç”¨ï¼‰
function setupSpreadsheetHeaders() {
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  
  // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã®è¨­å®š
  var headers = [
    'ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—',           // Aåˆ—
    'æ‹…å½“è€…å',                // Båˆ—  
    'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹',           // Cåˆ—
    'é›»è©±ç•ªå·',                // Dåˆ—
    'éƒ¨ç½²å',                  // Eåˆ—
    'å¾“æ¥­å“¡æ•°',                // Fåˆ—
    'å°å…¥ç›®çš„',                // Gåˆ—
    'ãƒ¡ãƒ¼ãƒ«é€ä¿¡çŠ¶æ…‹',           // Håˆ—
    'ä¼šç¤¾å',                  // Iåˆ—
    'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹',              // Jåˆ—
    'ãƒ•ã‚©ãƒ¼ãƒ ç¨®åˆ¥',            // Kåˆ—
    'è§£ç´„ç†ç”±',                // Låˆ—
    'è§£ç´„è©³ç´°ç†ç”±',            // Måˆ—
    'ä»Šå¾Œã®é€£çµ¡è¨±å¯',          // Nåˆ—
    'ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°é€£çµ¡è¨±å¯',  // Oåˆ—
    'å¸Œæœ›é€£çµ¡æ—¥æ™‚',            // Påˆ—
    'è¿½åŠ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸',          // Qåˆ—
    'è§£ç´„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'           // Råˆ—
  ];
  
  // ãƒ˜ãƒƒãƒ€ãƒ¼è¡ŒãŒç©ºã®å ´åˆã®ã¿è¨­å®š
  if (sheet.getRange(1, 1).getValue() === '') {
    for (var i = 0; i < headers.length; i++) {
      sheet.getRange(1, i + 1).setValue(headers[i]);
    }
    
    // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã®ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š
    var headerRange = sheet.getRange(1, 1, 1, headers.length);
    headerRange.setFontWeight('bold');
    headerRange.setBackground('#E3F2FD');
    
    Logger.log('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’è¨­å®šã—ã¾ã—ãŸ');
  } else {
    Logger.log('ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã¯æ—¢ã«è¨­å®šã•ã‚Œã¦ã„ã¾ã™');
  }
} 