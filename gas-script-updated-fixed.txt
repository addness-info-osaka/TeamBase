// TeamBase ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ãƒ•ã‚©ãƒ¼ãƒ ç”¨ã®GASã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆæ–°ã‚·ã‚¹ãƒ†ãƒ å¯¾å¿œç‰ˆï¼‰
// ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ç´ä»˜ã‘ã¦ä½¿ç”¨ã—ã¾ã™

// ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ - è©³ç´°ãªãƒ­ã‚°ã‚’å‡ºåŠ›ã—ã¾ã™
const DEBUG = true;

// ç®¡ç†è€…ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
const ADMIN_EMAIL = 'info.osaka@addness.co.jp';

// ä¼šç¤¾ã‹ã‚‰ã®é€ä¿¡è€…å
const COMPANY_NAME = 'SL.AI Team Base';
const COMPANY_EMAIL = 'noreply@sl-ai.com';

// Webã‚¢ãƒ—ãƒªã¨ã—ã¦å…¬é–‹ã—ãŸéš›ã®GETãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç†ã™ã‚‹é–¢æ•°
function doGet(e) {
  // GETãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å ´åˆã¯ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æƒ…å ±ã‚’è¿”ã™
  return ContentService.createTextOutput(JSON.stringify({
    status: 'TeamBaseç”³ã—è¾¼ã¿ã‚·ã‚¹ãƒ†ãƒ ',
    message: 'ç”³ã—è¾¼ã¿å‡¦ç†ã¯POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã§è¡Œã£ã¦ãã ã•ã„',
    timestamp: new Date().toString()
  })).setMimeType(ContentService.MimeType.JSON);
}

// Webã‚¢ãƒ—ãƒªã¨ã—ã¦å…¬é–‹ã—ãŸéš›ã®POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç†ã™ã‚‹é–¢æ•°
function doPost(e) {
  try {
    // POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    var postData = JSON.parse(e.postData.contents);
    
    // ãƒ­ã‚°å‡ºåŠ›ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
    if (DEBUG) {
      Logger.log("===== å—ä¿¡ãƒ‡ãƒ¼ã‚¿ =====");
      Logger.log(JSON.stringify(postData, null, 2));
    }
    
    // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’å–å¾—
    var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
    var lastRow = sheet.getLastRow() + 1;
    
    // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ä½œæˆï¼ˆAåˆ—ï¼‰
    var timestamp = new Date();
    
    // æ–°ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆã«åˆã‚ã›ã¦ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«æ›¸ãè¾¼ã‚€
    sheet.getRange(lastRow, 1).setValue(timestamp); // Aåˆ—: ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
    sheet.getRange(lastRow, 2).setValue(postData.columnB || ''); // Båˆ—: æ‹…å½“è€…å
    sheet.getRange(lastRow, 3).setValue(postData.columnC || ''); // Cåˆ—: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
    sheet.getRange(lastRow, 4).setValue(postData.columnD || ''); // Dåˆ—: é›»è©±ç•ªå·
    sheet.getRange(lastRow, 5).setValue(postData.columnE || ''); // Eåˆ—: éƒ¨ç½²å
    sheet.getRange(lastRow, 6).setValue(postData.columnF || ''); // Fåˆ—: å¾“æ¥­å“¡æ•°
    sheet.getRange(lastRow, 7).setValue(postData.columnG || ''); // Gåˆ—: å°å…¥ç›®çš„
    sheet.getRange(lastRow, 8).setValue('æœªé€ä¿¡'); // Håˆ—: ãƒ¡ãƒ¼ãƒ«é€ä¿¡çŠ¶æ…‹
    
    // ä¼šç¤¾æƒ…å ±ã‚’è¿½åŠ åˆ—ã«ä¿å­˜ï¼ˆæ–°ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆï¼‰
    if (postData.companyData) {
      sheet.getRange(lastRow, 9).setValue(postData.companyData.companyName || ''); // Iåˆ—: ä¼šç¤¾å
      sheet.getRange(lastRow, 10).setValue('trial'); // Jåˆ—: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆåˆæœŸå€¤ï¼štrialï¼‰
    } else {
      sheet.getRange(lastRow, 10).setValue('trial'); // Jåˆ—: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆåˆæœŸå€¤ï¼štrialï¼‰
    }
    
    // ç®¡ç†è€…ã¸ã®é€šçŸ¥ãƒ¡ãƒ¼ãƒ«é€ä¿¡
    sendAdminNotification(postData, lastRow);
    
    // ç”³ã—è¾¼ã¿è€…æœ¬äººã¸ã®ç¢ºèªãƒ¡ãƒ¼ãƒ«é€ä¿¡
    var emailSent = sendConfirmationEmail(postData);
    
    // ãƒ¡ãƒ¼ãƒ«é€ä¿¡çŠ¶æ…‹ã‚’æ›´æ–°
    if (emailSent) {
      sheet.getRange(lastRow, 8).setValue('é€ä¿¡å®Œäº†');
    } else {
      sheet.getRange(lastRow, 8).setValue('é€ä¿¡å¤±æ•—');
    }
    
    // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™
    return ContentService.createTextOutput(JSON.stringify({
      result: 'success',
      timestamp: timestamp.toString(),
      message: 'ãŠç”³ã—è¾¼ã¿ãƒ‡ãƒ¼ã‚¿ã‚’æ­£å¸¸ã«å—ä¿¡ã—ã€ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸ',
      rowNumber: lastRow,
      emailSent: emailSent
    })).setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    Logger.log("===== ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ =====");
    Logger.log("ã‚¨ãƒ©ãƒ¼: " + error.toString());
    
    return ContentService.createTextOutput(JSON.stringify({
      result: 'error',
      timestamp: new Date().toString(),
      message: 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ',
      error: error.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

// ç®¡ç†è€…ã¸ã®é€šçŸ¥ãƒ¡ãƒ¼ãƒ«é€ä¿¡
function sendAdminNotification(postData, rowNumber) {
  var subject = 'ã€TeamBaseã€‘æ–°ã—ã„ç„¡æ–™ãƒˆãƒ©ã‚¤ã‚¢ãƒ«ç”³ã—è¾¼ã¿ãŒã‚ã‚Šã¾ã—ãŸ';
  var body = `
æ–°ã—ã„TeamBaseã®ç„¡æ–™ãƒˆãƒ©ã‚¤ã‚¢ãƒ«ç”³ã—è¾¼ã¿ãŒã‚ã‚Šã¾ã—ãŸã€‚

ç”³ã—è¾¼ã¿è€…æƒ…å ±ï¼š
ä¼šç¤¾å: ${postData.companyData?.companyName || 'æœªå…¥åŠ›'}
æ‹…å½“è€…å: ${postData.columnB || 'æœªå…¥åŠ›'}
ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹: ${postData.columnC || 'æœªå…¥åŠ›'}
é›»è©±ç•ªå·: ${postData.columnD || 'æœªå…¥åŠ›'}
éƒ¨ç½²å: ${postData.columnE || 'æœªå…¥åŠ›'}
å¾“æ¥­å“¡æ•°: ${postData.columnF || 'æœªå…¥åŠ›'}
å°å…¥ç›®çš„: ${postData.columnG || 'æœªå…¥åŠ›'}

ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®${rowNumber}è¡Œç›®ã«è©³ç´°ã‚’è¨˜éŒ²ã—ã¾ã—ãŸã€‚
ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: trialï¼ˆãƒˆãƒ©ã‚¤ã‚¢ãƒ«é–‹å§‹ï¼‰

ç”³ã—è¾¼ã¿è€…ã«ã¯è‡ªå‹•ã§ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡æ¸ˆã¿ã§ã™ã€‚
12æ—¥å¾Œã«è‡ªå‹•çš„ã«ãƒˆãƒ©ã‚¤ã‚¢ãƒ«çµ‚äº†é€šçŸ¥ãŒé€ä¿¡ã•ã‚Œã¾ã™ã€‚
`;

  try {
    MailApp.sendEmail({
      to: ADMIN_EMAIL,
      subject: subject,
      body: body
    });
    Logger.log('ç®¡ç†è€…ã¸ã®é€šçŸ¥ãƒ¡ãƒ¼ãƒ«é€ä¿¡å®Œäº†');
  } catch (error) {
    Logger.log('ç®¡ç†è€…ã¸ã®é€šçŸ¥ãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—: ' + error.toString());
  }
}

// ç”³ã—è¾¼ã¿è€…æœ¬äººã¸ã®ç¢ºèªãƒ¡ãƒ¼ãƒ«é€ä¿¡
function sendConfirmationEmail(postData) {
  var email = postData.columnC;
  var name = postData.columnB;
  var companyName = postData.companyData?.companyName || '';
  
  if (!email) {
    Logger.log('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
    return false;
  }
  
  var subject = 'ã€TeamBaseã€‘ç„¡æ–™ãƒˆãƒ©ã‚¤ã‚¢ãƒ«ç”³ã—è¾¼ã¿æ‰¿èªãƒªãƒ³ã‚¯ã‚’ãŠé€ã‚Šã—ã¾ã™';
  
  // ã‚ªãƒ³ãƒœãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒšãƒ¼ã‚¸ã®ãƒªãƒ³ã‚¯ï¼ˆå®Ÿéš›ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã«å¤‰æ›´ã—ã¦ãã ã•ã„ï¼‰
  var onboardingLink = 'http://localhost:1800/onboarding.html'; // ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç”¨
  // æœ¬ç•ªç’°å¢ƒ: var onboardingLink = 'https://yourdomain.com/onboarding.html';
  
  var htmlBody = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <style>
    body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
    .container { max-width: 600px; margin: 0 auto; padding: 20px; }
    .header { background: linear-gradient(135deg, #4A6FFF 0%, #6B8AFF 100%); color: white; padding: 20px; text-align: center; border-radius: 8px 8px 0 0; }
    .content { background: #f8f9fa; padding: 30px; border-radius: 0 0 8px 8px; }
    .button { display: inline-block; background: linear-gradient(135deg, #4A6FFF 0%, #6B8AFF 100%); color: white; padding: 15px 30px; text-decoration: none; border-radius: 8px; margin: 20px 0; font-weight: bold; }
    .footer { text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; color: #666; font-size: 14px; }
    .trial-info { background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; margin: 20px 0; border-left: 4px solid #f39c12; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>TeamBase ç„¡æ–™ãƒˆãƒ©ã‚¤ã‚¢ãƒ«ç”³ã—è¾¼ã¿ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™</h1>
    </div>
    <div class="content">
      <p>${name} æ§˜</p>
      
      <p>ã“ã®åº¦ã¯ã€TeamBaseã®ç„¡æ–™ãƒˆãƒ©ã‚¤ã‚¢ãƒ«ã«ãŠç”³ã—è¾¼ã¿ã„ãŸã ãã€èª ã«ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚</p>
      
      <p><strong>ç”³ã—è¾¼ã¿å†…å®¹ç¢ºèªï¼š</strong></p>
      <ul>
        <li>ä¼šç¤¾å: ${companyName}</li>
        <li>æ‹…å½“è€…å: ${name}</li>
        <li>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹: ${email}</li>
      </ul>
      
      <div class="trial-info">
        <h3>ğŸ¯ 14æ—¥é–“ç„¡æ–™ãƒˆãƒ©ã‚¤ã‚¢ãƒ«é–‹å§‹</h3>
        <p><strong>ãƒˆãƒ©ã‚¤ã‚¢ãƒ«æœŸé–“:</strong> 14æ—¥é–“ï¼ˆæœ¬æ—¥ã‹ã‚‰ï¼‰<br>
        <strong>æ–™é‡‘:</strong> å®Œå…¨ç„¡æ–™<br>
        <strong>12æ—¥ç›®:</strong> è‡ªå‹•çš„ã«æœ‰æ–™ãƒ—ãƒ©ãƒ³ç§»è¡Œã®ã”æ¡ˆå†…ã‚’ãŠé€ã‚Šã—ã¾ã™</p>
      </div>
      
      <p>ç”³ã—è¾¼ã¿ã‚’æ‰¿èªã™ã‚‹ãŸã‚ã€ä¸‹è¨˜ã®ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚ªãƒ³ãƒœãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ï¼š</p>
      
      <p style="text-align: center;">
        <a href="${onboardingLink}" class="button">ã‚ªãƒ³ãƒœãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’é–‹å§‹ã™ã‚‹</a>
      </p>
      
      <p><strong>æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼š</strong></p>
      <ol>
        <li>ä¸Šè¨˜ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚ªãƒ³ãƒœãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹</li>
        <li>ãƒãƒ¼ãƒ è¨­å®šã¨åˆæœŸè¨­å®šã‚’å®Œäº†</li>
        <li>TeamBaseã®å…¨æ©Ÿèƒ½ã‚’ãŠè©¦ã—ãã ã•ã„</li>
      </ol>
      
      <p>ã”ä¸æ˜ãªç‚¹ãŒã”ã–ã„ã¾ã—ãŸã‚‰ã€ãŠæ°—è»½ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚</p>
      
      <p>ä»Šå¾Œã¨ã‚‚ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚</p>
    </div>
    <div class="footer">
      <p><strong>ã‚¢ãƒ‰ãƒã‚¹æ ªå¼ä¼šç¤¾ SL.AI Team Base</strong><br>
      ã€’540-0021 å¤§é˜ªåºœå¤§é˜ªå¸‚ä¸­å¤®åŒºå¤§æ‰‹é€šï¼’ä¸ç›®ï¼”âˆ’ï¼˜ assesså¤§æ‰‹é€šãƒ“ãƒ«ï¼”F<br>
      TEL: 06-4400-0754 | Email: info.osaka@addness.co.jp</p>
    </div>
  </div>
</body>
</html>
`;

  try {
    MailApp.sendEmail({
      to: email,
      subject: subject,
      htmlBody: htmlBody,
      name: COMPANY_NAME
    });
    Logger.log('ç”³ã—è¾¼ã¿è€…ã¸ã®ç¢ºèªãƒ¡ãƒ¼ãƒ«é€ä¿¡å®Œäº†: ' + email);
    return true;
  } catch (error) {
    Logger.log('ç”³ã—è¾¼ã¿è€…ã¸ã®ç¢ºèªãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—: ' + error.toString());
    return false;
  }
}

// ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é–‹ã„ãŸã¨ãã«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¿½åŠ 
function onOpen() {
  var ui = SpreadsheetApp.getUi();
  ui.createMenu('TeamBase')
    .addItem('æ‰‹å‹•ã§ãƒ¡ãƒ¼ãƒ«é€ä¿¡', 'manualSendEmails')
    .addItem('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆåˆæœŸåŒ–', 'setupSheet')
    .addItem('ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«é€ä¿¡', 'sendTestEmail')
    .addSeparator()
    .addItem('ãƒˆãƒ©ã‚¤ã‚¢ãƒ«ç®¡ç†ãƒˆãƒªã‚¬ãƒ¼è¨­å®š', 'setupTrialTrigger')
    .addToUi();
}

// ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’åˆæœŸåŒ–ã™ã‚‹é–¢æ•°ï¼ˆæ–°ã‚·ã‚¹ãƒ†ãƒ å¯¾å¿œï¼‰
function setupSheet() {
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  var ui = SpreadsheetApp.getUi();
  
  // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
  var response = ui.alert(
    'ç¢ºèª',
    'ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’åˆæœŸåŒ–ã—ã¾ã™ã‹ï¼Ÿæ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã¯æ¶ˆå»ã•ã‚Œã¾ã™ã€‚',
    ui.ButtonSet.YES_NO
  );
  
  if (response == ui.Button.YES) {
    // ã‚·ãƒ¼ãƒˆã‚’ã‚¯ãƒªã‚¢
    sheet.clear();
    
    // æ–°ã‚·ã‚¹ãƒ†ãƒ å¯¾å¿œãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’è¨­å®š
    sheet.getRange("A1:M1").setValues([["ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—", "æ‹…å½“è€…å", "ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹", "é›»è©±ç•ªå·", "éƒ¨ç½²å", "å¾“æ¥­å“¡æ•°", "å°å…¥ç›®çš„", "ãƒ¡ãƒ¼ãƒ«é€ä¿¡çŠ¶æ…‹", "ä¼šç¤¾å", "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹", "è§£ç´„ç†ç”±", "è©³ç´°ç†ç”±", "è§£ç´„æ—¥æ™‚"]]);
    
    // åˆ—å¹…ã®èª¿æ•´
    sheet.setColumnWidth(1, 150); // Aåˆ—: ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
    sheet.setColumnWidth(2, 120); // Båˆ—: æ‹…å½“è€…å
    sheet.setColumnWidth(3, 200); // Cåˆ—: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
    sheet.setColumnWidth(4, 120); // Dåˆ—: é›»è©±ç•ªå·
    sheet.setColumnWidth(5, 120); // Eåˆ—: éƒ¨ç½²å
    sheet.setColumnWidth(6, 100); // Fåˆ—: å¾“æ¥­å“¡æ•°
    sheet.setColumnWidth(7, 300); // Gåˆ—: å°å…¥ç›®çš„
    sheet.setColumnWidth(8, 120); // Håˆ—: ãƒ¡ãƒ¼ãƒ«é€ä¿¡çŠ¶æ…‹
    sheet.setColumnWidth(9, 200); // Iåˆ—: ä¼šç¤¾å
    sheet.setColumnWidth(10, 120); // Jåˆ—: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
    sheet.setColumnWidth(11, 120); // Kåˆ—: è§£ç´„ç†ç”±
    sheet.setColumnWidth(12, 200); // Låˆ—: è©³ç´°ç†ç”±
    sheet.setColumnWidth(13, 150); // Måˆ—: è§£ç´„æ—¥æ™‚
    
    // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã®æ›¸å¼è¨­å®š
    sheet.getRange("A1:M1").setBackground("#4A6FFF").setFontColor("#FFFFFF").setFontWeight("bold");
    
    ui.alert('å®Œäº†', 'ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãŒæ–°ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆã§åˆæœŸåŒ–ã•ã‚Œã¾ã—ãŸã€‚', ui.ButtonSet.OK);
  }
}

// ãƒˆãƒ©ã‚¤ã‚¢ãƒ«ç®¡ç†ãƒˆãƒªã‚¬ãƒ¼è¨­å®šã®ãƒ˜ãƒ«ãƒ‘ãƒ¼
function setupTrialTrigger() {
  var ui = SpreadsheetApp.getUi();
  ui.alert('è¨­å®š', 'ãƒˆãƒ©ã‚¤ã‚¢ãƒ«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã¯ã€simple-trial-management.txtã®GASã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’åŒã˜ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è¿½åŠ ã—ã€setupDailyTrigger()ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚', ui.ButtonSet.OK);
}

// ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«é€ä¿¡
function sendTestEmail() {
  var ui = SpreadsheetApp.getUi();
  
  var testData = {
    columnB: 'ãƒ†ã‚¹ãƒˆ å¤ªéƒ',
    columnC: 'test@example.com', // â† å®Ÿéš›ã®ãƒ†ã‚¹ãƒˆç”¨ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«å¤‰æ›´
    columnD: '090-1234-5678',
    columnE: 'å–¶æ¥­éƒ¨',
    columnF: '10-20å',
    columnG: 'ãƒãƒ¼ãƒ ç®¡ç†ã®åŠ¹ç‡åŒ–',
    companyData: {
      companyName: 'ãƒ†ã‚¹ãƒˆæ ªå¼ä¼šç¤¾'
    }
  };
  
  var result = sendConfirmationEmail(testData);
  
  if (result) {
    ui.alert('æˆåŠŸ', 'ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚', ui.ButtonSet.OK);
  } else {
    ui.alert('å¤±æ•—', 'ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', ui.ButtonSet.OK);
  }
}

// æ‰‹å‹•ã§ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã™ã‚‹ãŸã‚ã®é–¢æ•°
function manualSendEmails() {
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  var ui = SpreadsheetApp.getUi();
  
  // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
  var response = ui.alert(
    'ç¢ºèª',
    'æœªé€ä¿¡ã®ç”³ã—è¾¼ã¿è€…å…¨å“¡ã«ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ',
    ui.ButtonSet.YES_NO
  );
  
  if (response == ui.Button.YES) {
    var data = sheet.getDataRange().getValues();
    var sent = 0;
    var failed = 0;
    
    // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦2è¡Œç›®ã‹ã‚‰å‡¦ç†
    for (var i = 1; i < data.length; i++) {
      // Håˆ—ãŒã€Œæœªé€ä¿¡ã€ã®å ´åˆã®ã¿ãƒ¡ãƒ¼ãƒ«é€ä¿¡
      if (data[i][7] === "æœªé€ä¿¡") {
        var testData = {
          columnB: data[i][1],
          columnC: data[i][2],
          columnD: data[i][3],
          columnE: data[i][4],
          columnF: data[i][5],
          columnG: data[i][6],
          companyData: {
            companyName: data[i][8]
          }
        };
        
        if (sendConfirmationEmail(testData)) {
          // é€ä¿¡æ¸ˆã¿ãƒ•ãƒ©ã‚°ã‚’è¨­å®š
          sheet.getRange(i + 1, 8).setValue("é€ä¿¡å®Œäº†");
          sent++;
        } else {
          sheet.getRange(i + 1, 8).setValue("é€ä¿¡å¤±æ•—");
          failed++;
        }
      }
    }
    
    var message = sent + 'ä»¶ã®ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚';
    if (failed > 0) {
      message += '\n' + failed + 'ä»¶ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
    }
    
    ui.alert('é€ä¿¡å®Œäº†', message, ui.ButtonSet.OK);
  }
} 